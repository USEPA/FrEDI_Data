---
title: "Install New FrEDI R Package"
author: "Industrial Economics, Inc."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmarkdown::html_document:
    theme: spacelab
    toc: true
    toc_float: true
---

<style>
/* Simplified version of Bootstrap's responsive table CSS */
.table-responsive {
    display: block;
    width: 100%;
    overflow-x: auto;
}

.table-responsive > table {
    width: 100%;
}
</style>


```{r knitr setup, include=FALSE}
### The following parameters declare the options for compiling the Markdown document.
knitr::opts_chunk$set(
  include = T,     ### Evaluate and depict outputs of code chunks in the compiled document
  echo    = T,     ### Echo the commands of the code chunks in the compiled document
  message = FALSE, ### Don't include command-line messages output from evaluating code chunks
  cache   = FALSE, ### Don't cache the evaluation of code chunks
  warning = FALSE,  ### Don't include warnings from evaluating code chunks
  table.format = "html" 
)
```

## Overview

The purpose of this package is to install the R package after configuration. First run "1_configure_FrEDI_main.Rmd", "2_configure_FrEDI_SV.Rmd", and "3_build_FrEDI.Rmd" prior to running "4_install_FrEDI.Rmd".

Then, restart the R Session using the command `Ctrl+Shift+F10`.

### Prepare Workspace


Load packages 

```{r loadPackages}
### Packages
require(tidyverse)
require(openxlsx)
require(devtools)
```


File paths


```{r declare paths}
### Set print options
options(digits = 20)
### Set system paths
# projectPath      <- getwd()
projectPath      <- "."
today            <- format(Sys.Date(), "%Y%m%d")

### Path to fredi project
projectParentDir <- projectPath %>% file.path("..")
projectParentDir %>% list.files
frediPath        <- projectParentDir %>% file.path("FrEDI")
```

## Install FrEDI


Restart R and any sessions that have FrEDI loaded. Then run "00_install.R"

### Get Version Number

```{r packageVersion}
frediVersions  <- projectParentDir %>% list.files(pattern=".tar.gz") %>% sort; frediVersions
packageVersion <- frediVersions %>% last %>% (function(x){gsub("FrEDI_", "", x)}) %>% (function(x){gsub("\\.tar\\.gz", "", x)}); packageVersion
```


### Update Install Functions



```{r install_fredi}
###### README ######
### This script is intended to help users install the package from source or the GitHub repository.
### It is intended to cover general cases and may not cover all install requirements.
### If installing from source (rather than GitHub):
### - Copy tar.gz file to your R library before running this script
### - You can check the location of your R library by typing '.libPaths()[1]' into the command line
install_fredi <- function(
  installFrom = NULL, ### Select a number, one or two
  package     = "FrEDI",
  version     = packageVersion,
  verbose     = FALSE, 
  libPath     = .libPaths()[1] ### Location of library path
){
  ###### Load Packages ######
  require(devtools)
  require(tidyverse)
  require(withr)

  ###### Install Type Prompt ######
  if(is.null(installFrom)){
    installPrompt <- "Select install option number (1 - from GitHub, 2 - local, from source):"
    installFrom   <- readline(prompt = installPrompt)
  }

  ###### Package Info ######
  package_name      <- package ### Package name
  package_version   <- version ### Package version number
  package_file      <- package_name %>% paste0("_", package_version, ".", "tar.gz")

  ###### Install from GitHub ######
  if(installFrom == "1"){
    ### Option for a different Git repo
    withr::with_libpaths(
      new = .libPaths()[1],
      remotes::install_github(
        repo   = "https://github.com/USEPA/FrEDI",
        subdir = package_name,
        type   = "source",
        repos  = getOption("repos"),
        force  = TRUE
      )
    )
  }
  ###### Install from Source ######
  else if(installFrom == "2"){
    ### Otherwise, install from source
    "Copy tar.gz file to your R library before running this script..." %>% message
    "Check location of your R library by typing '.libPaths()[1]' into the command line..." %>% message

    ###### Package Location
    package_location  <- libPath; #package_location
    package_path      <- package_location %>% file.path(package_name)
    package_filePath  <- package_location %>% file.path(package_file)
    # package_location %>% list.files

    ###### Check Files
    ### Check existance of package file
    package_fileExists <- package_filePath %>% file.exists
    ### Return without doing anything if package doesn't exist
    if(!package_fileExists){
      paste0("Warning: ", package_file, " not found in ", package_location, "...") %>% message
      paste0("\t", "Add", package_file, " to ", package_location, " and then rerun this script.", "\n") %>% message
      paste0("Exiting...") %>% message
      return()
    } else{
      ### If the package exists, try to install the package
      ### First check whether package already installed
      package_exists     <- package_path %>% dir.exists
      ###### Remove Previous Library
      ### If package is already installed, remove the previous install
      ### Then check that it was removed and install the package
      if(package_exists){
        paste0("Warning: ", package, " already exists!") %>% message
        removePrompt <- paste0("Remove existing install? (y/n)")
        removeInput  <- readline(prompt = removePrompt) %>% tolower
        if(removeInput=="y"){
          unlink(package_path, recursive = T)
          install.packages(package_filePath, repos=NULL, type="source", lib=package_location)
        } else{
          paste0("Exiting without installing...") %>% message
          return()
        }
      } else{
        ###### Install the Package
        install.packages(package_filePath, repos=NULL, type="source", lib=package_location, verbose=verbose)
      }
    }
  }
  ###### Exit without installing ######
  else{
    paste0("Warning: No option selected.", "\n") %>% message
    paste0("Exiting without installing...") %>% message
    return()
  }
}
```




### Install FrEDI

```{r run install_fredi}
# install_fredi(version="3.3.2")
install_fredi()
```




